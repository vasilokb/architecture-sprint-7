# 1. Описание контекста
- **Система:** PropDevelopment (с расширением за счёт новых сервисов "Умного дома").
- **Пользователи:** Собственники (основные пользователи мобильного приложения), менеджеры (управляют данными и доступом), партнёр (предоставляет сервисы).
- **Новые функции:** Интеллектуальный домофон и шлагбаум, доступные через мобильное приложение owner_services_showcase.
- **Внешние системы:** Партнёрские сервисы домофона и шлагбаума, управляющая компания, платёжные системы (из текущей архитектуры).

---

## Диаграмма контекста 
```plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

' Пользователи
Person(owner, "Собственник", "Использует мобильное приложение для доступа к услугам ЖКХ и 'Умному дому'")
Person(manager, "Менеджер", "Управляет данными собственников и доступом к сервисам")
Person(partner, "Партнёр", "Предоставляет сервисы интеллектуального домофона и шлагбаума")

' Основная система
System_Boundary(prop_development, "PropDevelopment") {
  System(app, "Мобильное приложение собственников", "Интерфейс для доступа к услугам ЖКХ, 'Умному дому', домофону и шлагбауму")
}

' Внешние системы
System_Ext(utility_provider, "Управляющая компания", "Предоставляет данные о ЖКХ")
System_Ext(payment_system, "Платёжная система", "Провайдер онлайн-платежей")
System_Ext(partner_domofon, "Сервис интеллектуального домофона", "Обеспечивает видеодомофон и биометрию")
System_Ext(partner_slagbaum, "Сервис интеллектуального шлагбаума", "Обеспечивает управление шлагбаумом и распознавание номеров")

' Связи
Rel(owner, app, "Использует для управления 'Умным домом', домофоном и шлагбаумом", "REST")
Rel(app, utility_provider, "Получает данные о ЖКХ", "REST")
Rel(app, payment_system, "Оплата услуг", "REST, WS")
Rel(app, partner_domofon, "Управление домофоном, биометрия", "REST")
Rel(app, partner_slagbaum, "Управление шлагбаумом, распознавание номеров", "REST")
Rel(manager, app, "Управляет доступом и данными", "REST")
Rel(partner, partner_domofon, "Предоставляет и поддерживает сервис", "API")
Rel(partner, partner_slagbaum, "Предоставляет и поддерживает сервис", "API")

' Оформление
SHOW_LEGEND()
@enduml
```

---

### Пояснение к диаграмме
1. **Центральная система:**
    - **Мобильное приложение собственников (owner_services_showcase)**: Расширено для поддержки новых функций — управления интеллектуальным домофоном и шлагбаумом. Это основная точка взаимодействия собственников с системой.

2. **Пользователи:**
    - **Собственник:** Использует приложение для доступа к ЖКХ, текущим функциям "Умного дома" и новым сервисам (домофон, шлагбаум).
    - **Менеджер:** Управляет доступом (например, регистрация лиц и номеров автомобилей).
    - **Партнёр:** Поставщик сервисов, взаимодействует с PropDevelopment через API.

3. **Внешние системы:**
    - **Управляющая компания (utility_provider)**: Остаётся из текущей архитектуры для данных ЖКХ.
    - **Платёжная система (payment_system)**: Для оплаты услуг (без изменений).
    - **Сервис интеллектуального домофона (partner_domofon)**: Новый внешний сервис, предоставляет видеодомофон и биометрию.
    - **Сервис интеллектуального шлагбаума (partner_slagbaum)**: Новый внешний сервис, управляет шлагбаумом и распознаёт номера.

4. **Связи:**
    - Собственники используют приложение через REST (мобильный интерфейс).
    - Приложение интегрируется с новыми сервисами партнёра через REST (предполагаемый протокол для внешних API).
    - Менеджеры управляют доступом через приложение.
    - Партнёр поддерживает свои сервисы через собственные API.

---

### Примечания
- **Предположения:** предполагается, что новые сервисы будут интегрированы через REST, как большинство текущих внешних интеграций (например, utility_provider). Если партнёр использует другой протокол (например, WebSocket), это можно скорректировать.
- **Упрощение:** Диаграмма контекста не включает внутренние системы (tenant-core-app, CRM), так как фокус — на внешнем взаимодействии. 

---

# 2. Предлагаемые изменения в ландшафте систем

## 1. Новая подсистема для управления доступом "Умного дома" (SmartHome Access Service)
- **Основание:** Текущий tenant-core-app отвечает за услуги ЖКХ и базовые функции "Умного дома". Добавление домофона (биометрия) и шлагбаума (распознавание номеров) увеличивает нагрузку и усложняет управление доступом. Выделение отдельного сервиса упростит обработку данных доступа и повысит безопасность.
- **Что добавляем:** Новый контейнер `smarthome-access-service` (Kotlin, SpringBoot) с базой данных `smarthome-access-db` (PostgreSQL) для хранения и проверки данных доступа (лица, номера автомобилей).
- **Эффект:** Разделение ответственности, снижение риска утечек через tenant-core-app.

## 2. API Gateway для внешних интеграций
- **Основание:** Проблемы с API партнёров (избыточная передача данных, отсутствие политик) требуют централизованного контроля. Текущие REST-интеграции (owner_services_showcase → partner_domofon) уязвимы.
- **Что добавляем:** Новый контейнер `api-gateway` (например, Spring Cloud Gateway) для фильтрации, логирования и шифрования всех внешних REST-запросов.
- **Эффект:** Усиление безопасности API, устранение избыточной передачи данных.

## 3. Обновление tenant-core-app
- **Основание:** tenant-core-app должен передать управление доступом новому сервису, но продолжать обрабатывать текущие функции "Умного дома" (автоматика, замки).
- **Что меняем:** Убираем из tenant-core-app функции проверки доступа для домофона и шлагбаума, оставляем только базовые функции "Умного дома".
- **Эффект:** Снижение нагрузки и упрощение логики.

## 4. Расширение owner_services_showcase
- **Основание:** Мобильное приложение должно поддерживать новые функции (видеодомофон, управление шлагбаумом) без перегрузки интерфейса.
- **Что меняем:** Добавляем модули для взаимодействия с `smarthome-access-service` и партнёрскими сервисами через `api-gateway`.
- **Эффект:** Плавная интеграция новых функций для собственников.

## 5. Интеграция с CRM
- **Основание:** Данные о собственниках (crm-tenant-db) нужны для управления доступом (регистрация лиц и номеров). Несогласованность данных — текущая проблема.
- **Что меняем:** Добавляем синхронизацию между `smarthome-access-service` и CRM через REST.
- **Эффект:** Устранение дубликатов и обеспечение актуальности данных.

---

```plantuml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

' Пользователи
Person(owner, "Собственник", "Использует мобильное приложение для доступа к услугам")
Person(manager, "Менеджер", "Управляет данными и доступом")

' Внешние системы
System_Ext(utility_provider, "Управляющая компания", "Данные о ЖКХ")
System_Ext(payment_system, "Платёжная система", "Онлайн-платежи")
System_Ext(partner_domofon, "Сервис интеллектуального домофона", "Видеодомофон и биометрия")
System_Ext(partner_slagbaum, "Сервис интеллектуального шлагбаума", "Управление шлагбаумом и распознавание номеров")

' Брандмауэр
System(firewall_utility, "Брандмауэр ЖКУ", "Фильтрует трафик для сервисов ЖКУ") #red

' Основная система PropDevelopment
System_Boundary(prop_development, "PropDevelopment") {
  Container(owner_services_showcase, "Мобильное приложение собственников", "iOS, Android", "Интерфейс для ЖКХ, 'Умного дома', домофона и шлагбаума")
  Container(api_gateway, "API Gateway", "Spring Cloud Gateway", "Централизованное управление внешними API") #lightblue
  Container(tenant_core_app, "tenant-core-app", "Kotlin, SpringBoot", "Услуги ЖКХ и базовые функции 'Умного дома'")
  ContainerDb(tenant_core_db, "tenant-core-db", "PostgreSQL", "Данные ЖКХ и базового 'Умного дома'")
  Container(smarthome_access_service, "smarthome-access-service", "Kotlin, SpringBoot", "Управление доступом для домофона и шлагбаума") #lightblue
  ContainerDb(smarthome_access_db, "smarthome-access-db", "PostgreSQL", "Данные доступа: лица, номера автомобилей") #grey
  Container(crm, "CRM", "Kotlin, SpringBoot", "Управление данными собственников")
  ContainerDb(crm_tenant_db, "crm-tenant-db", "PostgreSQL", "Персональные данные собственников")
  Container(auth_service_1, "auth-service-1", "Keycloak", "Аутентификация собственников")
  ContainerDb(auth_db_1, "auth-db-1", "PostgreSQL", "Данные аутентификации")
  Container(active_directory, "Active Directory", "MS Active Directory", "Служба каталогов для сотрудников")
}

' Связи
Rel(owner, firewall_utility, "Взаимодействие", "REST")
Rel(firewall_utility, owner_services_showcase, "Отфильтрованное взаимодействие", "REST")
Rel(manager, owner_services_showcase, "Управление доступом и данными", "REST")

' Взаимодействия внутри системы
Rel(owner_services_showcase, auth_service_1, "Аутентификация", "REST")
Rel(owner_services_showcase, api_gateway, "Запросы к внешним сервисам", "REST")
Rel(owner_services_showcase, tenant_core_app, "Услуги ЖКХ и базовый 'Умный дом'", "REST")
Rel(owner_services_showcase, smarthome_access_service, "Управление домофоном и шлагбаумом", "REST")
Rel(owner_services_showcase, crm, "Данные собственников", "REST")
Rel(tenant_core_app, tenant_core_db, "Хранение данных", "JDBC")
Rel(smarthome_access_service, smarthome_access_db, "Хранение данных доступа", "JDBC")
Rel(smarthome_access_service, crm, "Синхронизация данных собственников", "REST")
Rel(crm, crm_tenant_db, "Хранение данных", "JDBC")
Rel(auth_service_1, auth_db_1, "Хранение данных", "TCP")
Rel(auth_service_1, active_directory, "Аутентификация", "LDAP")
Rel(crm, active_directory, "Аутентификация менеджеров", "LDAP")

' Взаимодействия с внешними системами через API Gateway
Rel(api_gateway, utility_provider, "Данные о ЖКХ", "REST")
Rel(api_gateway, payment_system, "Оплата услуг", "REST, WS")
Rel(api_gateway, partner_domofon, "Управление домофоном, биометрия", "REST")
Rel(api_gateway, partner_slagbaum, "Управление шлагбаумом, распознавание номеров", "REST")
Rel(smarthome_access_service, partner_domofon, "Проверка доступа по биометрии", "REST")
Rel(smarthome_access_service, partner_slagbaum, "Проверка доступа по номерам", "REST")

' Оформление
SHOW_LEGEND()
@enduml
```

---

### Пояснение к изменениям в диаграмме

#### 1. Новые контейнеры
- **api-gateway:** Централизует все внешние REST-запросы (utility_provider, payment_system, partner_domofon, partner_slagbaum). Фильтрует данные, логирует запросы, обеспечивает шифрование.
- **smarthome-access-service:** Отдельный сервис для управления доступом к домофону (биометрия) и шлагбауму (номера). Интегрируется с CRM для актуальности данных.
- **smarthome-access-db:** Хранит данные доступа (список лиц, номеров), отделён от tenant-core-db для безопасности.

#### 2. Обновлённые связи
- **owner_services_showcase → api-gateway:** Все внешние запросы проходят через шлюз для контроля.
- **owner_services_showcase → smarthome-access-service:** Приложение напрямую обращается к новому сервису для управления доступом.
- **smarthome-access-service → crm:** Синхронизация данных о собственниках (лица, номера).
- **smarthome-access-service → partner_domofon/slagbaum:** Проверка доступа через REST.
- **tenant-core-app:** Ограничен базовыми функциями "Умного дома", не обрабатывает новые сервисы.

#### 3. Эффект изменений
- **Безопасность:** API Gateway устраняет избыточную передачу данных, smarthome-access-service изолирует секретные данные (коды, биометрию).
- **Согласованность:** Синхронизация с CRM решает проблему дубликатов.
- **Масштабируемость:** Разделение tenant-core-app и smarthome-access-service упрощает дальнейшее расширение "Умного дома".

---

# Список требований к внешним интеграциям

## 1. Требования к безопасности

1. **Шифрование данных в транзите**
    - Все данные, передаваемые между PropDevelopment и сервисами партнёра (partner_domofon, partner_slagbaum), должны быть зашифрованы с использованием TLS 1.3.
    - Минимальная длина ключа: 256 бит (AES-256).
    - Причина: Предотвращение перехвата персональных данных (биометрия, номера автомобилей).

2. **Шифрование данных на уровне хранения**
    - Биометрические данные (лица) и номера автомобилей в smarthome-access-db должны храниться в зашифрованном виде (например, AES-256).
    - Ключи шифрования должны управляться отдельно через защищённый сервис (например, HashiCorp Vault).
    - Причина: Защита от утечек при компрометации базы данных.

3. **Ограничение передаваемых данных**
    - API Gateway должен фильтровать запросы и ответы, передавая только минимально необходимые данные (например, только user_id и статус доступа, а не полные профили собственников).
    - Причина: Устранение избыточной передачи данных, как в текущих проблемах с utility_provider.

4. **Логирование и мониторинг**
    - Все запросы к partner_domofon и partner_slagbaum через API Gateway должны логироваться с указанием времени, источника, типа запроса и статуса.
    - Логи должны храниться в защищённом виде (шифрование, ограниченный доступ) минимум 6 месяцев.
    - Причина: Обеспечение трассировки инцидентов и соответствие законодательству.

5. **Защита от атак**
    - API Gateway должен включать механизмы защиты от DDoS (rate limiting) и SQL-инъекций (валидация входных данных).
    - Партнёрские сервисы должны поддерживать аналогичные меры.
    - Причина: Предотвращение внешних атак через новые интеграции.

6. **Изоляция данных доступа**
    - Данные доступа (биометрия, номера) должны быть изолированы в smarthome-access-db и не передаваться напрямую в tenant-core-db или crm-tenant-db.
    - Причина: Снижение риска утечки через существующие системы.

---

## 2. Протоколы аутентификации и авторизации
PropDevelopment уже использует auth-service-1 (Keycloak) и Active Directory. Новые интеграции должны быть совместимы с этой инфраструктурой.

1. **Аутентификация**
    - **Протокол:** OAuth 2.0 с OpenID Connect (OIDC).
    - **Реализация:**
        - auth-service-1 выдаёт JWT-токены для собственников при входе в мобильное приложение (owner_services_showcase).
        - Токены передаются через API Gateway к partner_domofon и partner_slagbaum в заголовке Authorization (Bearer <token>).
    - **Требования:**
        - Токены должны иметь срок действия не более 15 минут с возможностью обновления через refresh-токен.
        - Партнёр обязан проверять подпись токена с использованием публичного ключа auth-service-1.
    - **Причина:** Централизованная аутентификация, минимизация риска компрометации долгоживущих токенов.

2. **Авторизация**
    - **Протокол:** Role-Based Access Control (RBAC) через scopes в JWT.
    - **Реализация:**
        - Токены включают scopes (например, `domofon:control`, `slagbaum:control`), определяющие права доступа.
        - smarthome-access-service проверяет scopes перед передачей данных партнёру.
    - **Требования:**
        - Партнёр должен запрашивать разрешение доступа у smarthome-access-service для каждого действия (например, открытие двери).
        - Доступ предоставляется только для зарегистрированных user_id в smarthome-access-db.
    - **Причина:** Ограничение прав партнёра, устранение доступа к чужим данным.

3. **Взаимная аутентификация**
    - **Протокол:** Взаимный TLS (mTLS) между API Gateway и партнёрскими сервисами.
    - **Реализация:**
        - PropDevelopment и партнёр обмениваются сертификатами для проверки подлинности.
        - API Gateway отклоняет запросы без валидного сертификата партнёра.
    - **Требования:** Сертификаты обновляются ежегодно, отзываются при компрометации.
    - **Причина:** Подтверждение легитимности партнёрских сервисов.

---

## 3. Взаимодействие между системами предприятия и внешней платформой
Взаимодействие организовано через REST с использованием API Gateway как точки входа/выхода.

### Сценарий 1: Открытие домофона по звонку
1. **Собственник → owner_services_showcase:**
    - Пользователь нажимает "Открыть дверь" в приложении.
    - Запрос: `POST /domofon/open` с JWT-токеном.
2. **owner_services_showcase → api-gateway:**
    - Приложение перенаправляет запрос через API Gateway.
    - API Gateway проверяет токен (auth-service-1) и scope (`domofon:control`).
3. **api-gateway → partner_domofon:**
    - Запрос: `POST /api/domofon/open` с user_id и device_id.
    - mTLS подтверждает подлинность PropDevelopment.
4. **partner_domofon → smarthome_access_service:**
    - Партнёр запрашивает проверку доступа: `POST /access/verify` с user_id и biometric_data.
5. **smarthome_access_service → partner_domofon:**
    - Проверяет доступ в smarthome-access-db, возвращает: `{"access_granted": true}`.
6. **partner_domofon → физический домофон:**
    - Открывает дверь, возвращает статус через API Gateway в приложение.

### Сценарий 2: Автоматическое открытие шлагбаума
1. **partner_slagbaum → api-gateway:**
    - Шлагбаум распознаёт номер, отправляет: `POST /access/verify` с plate_number.
    - mTLS аутентифицирует партнёра.
2. **api-gateway → smarthome_access_service:**
    - Перенаправляет запрос для проверки.
3. **smarthome_access_service → partner_slagbaum:**
    - Проверяет номер в smarthome-access-db, возвращает: `{"access_granted": true}`.
4. **partner_slagbaum → физический шлагбаум:**
    - Открывает шлагбаум, логирует действие.

### Сценарий 3: Синхронизация данных
1. **crm → smarthome_access_service:**
    - Регулярная синхронизация (REST, раз в час): `POST /sync/users` с данными о собственниках (лица, номера).
2. **smarthome_access_service → smarthome_access_db:**
    - Обновляет базу данных доступа.

### Ключевые аспекты взаимодействия
- **Протокол:** REST (HTTP/1.1 или HTTP/2).
- **Формат данных:** JSON.
- **Точка входа:** API Gateway для всех внешних запросов.
- **Логика проверки:** smarthome-access-service отвечает за авторизацию доступа.
- **Обратная связь:** Партнёр отправляет статусы действий (например, "door_opened") через REST.

---

### Итоговый список требований

#### Безопасность
1. Шифрование данных в транзите (TLS 1.3, AES-256).
2. Шифрование данных на уровне хранения (AES-256, управление ключами).
3. Ограничение передаваемых данных через API Gateway.
4. Логирование всех запросов (6 месяцев, шифрование).
5. Защита от DDoS и инъекций в API Gateway.
6. Изоляция данных доступа в smarthome-access-db.

#### Протоколы аутентификации и авторизации
1. OAuth 2.0 + OIDC (JWT-токены, 15 минут, refresh-токены).
2. RBAC через scopes в JWT (например, `domofon:control`).
3. mTLS между API Gateway и партнёрскими сервисами.

#### Взаимодействие
1. REST (JSON) через API Gateway.
2. owner_services_showcase → api-gateway → partner_domofon/slagbaum для управления.
3. partner_domofon/slagbaum → smarthome_access_service для проверки доступа.
4. crm → smarthome_access_service для синхронизации данных.

---
